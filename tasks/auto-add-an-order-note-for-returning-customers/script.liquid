{% capture newline %}
{% endcapture %}

{% if options.ignore_customers_who_previously_ordered_after_this_date != blank and options.ignore_customers_who_previously_ordered_less_than_x_days_ago__number != blank %}
  {"error": "Choose only one \"ignore\" option at a time. Thanks! :)"}
{% endif %}

{% if options.ignore_customers_who_previously_ordered_after_this_date != blank %}
  {% assign nonsense_s = "asdf" | date: "%s" | times: 1 %}
  {% assign previous_order_threshold_s = options.ignore_customers_who_previously_ordered_after_this_date | date: "%s" | times: 1 %}
  {% if previous_order_threshold_s == nonsense_s %}
    {"error": {{ options.ignore_customers_who_previously_ordered_after_this_date | json | append: " was not recognized as a valid date" | json }}}
  {% endif %}
{% elsif options.ignore_customers_who_previously_ordered_less_than_x_days_ago__number != blank %}
  {% assign time_window_s = options.ignore_customers_who_previously_ordered_less_than_x_days_ago__number | times: 24 | times: 60 | times: 60 %}
  {% assign previous_order_threshold_s = "now" | date: "%s" | minus: time_window_s %}
{% endif %}

{% if previous_order_threshold_s and event.preview %}
  {% action "echo" %}
    ["Ignoring when previous order was after:", {{ previous_order_threshold_s | date: "%Y-%m-%d %T %Z" | json }}]
  {% endaction %}
{% endif %}

{% assign previous_order_qualifies = false %}
{% if previous_order_threshold_s == nil %}
  {% assign previous_order_qualifies = true %}
{% else %}
  {% assign previous_order = order.customer.orders.first %}
  {% if previous_order %}
    {% assign previous_order_created_at_s = order.customer.orders.first.created_at | date: "%s" | times: 1 %}
    {% if previous_order_created_at_s < previous_order_threshold_s %}
      {% assign previous_order_qualifies = true %}
    {% endif %}
  {% endif %}
{% endif %}

{% if event.preview or previous_order_created_at_s < previous_order_threshold_s %}
  {% assign note = order.note | append: newline | append: newline | append: options.order_note_to_add__required_multiline | strip %}

  {% action "shopify" %}
    [
      "update",
      [
        "order",
        {{ order.id | json }}
      ],
      {
        "note": {{ note | json }}
      }
    ]
  {% endaction %}
{% endif %}