{% assign tag_to_watch_for = options.tag_to_watch_for__required %}
{% capture email_sent_tag %}{{ tag_to_watch_for }}-email-sent{% endcapture %}
{% assign order_tags = order.tags | split: ", " %}

{% assign order_qualifies = false %}
{% assign order_created_at = order.created_at | date: "%s" %}
{% assign task_created_at = task.created_at | date: "%s" %}
{% if order_tags contains tag_to_watch_for and order_created_at >= task_created_at %}
  {% unless order_tags contains email_sent_tag %}
    {% assign order_qualifies = true %}
  {% endunless %}
{% endif %}

{% assign email_recipients = options.email_recipients__required %}
{% assign email_subject = options.email_subject__required %}
{% assign email_body = options.email_body__required_multiline | strip | newline_to_br %}

{% if event.preview or order_qualifies %}
  {
    "action": {
      "type": "email",
      "options": {
        "to": {{ email_recipients | json }},
        "subject": {{ email_subject | json }},
        "body": {{ email_body | json }},
        "reply_to": {{ shop.customer_email | json }},
        "from_display_name": {{ shop.name | json }}
      }
    }
  }

  {
    "action": {
      "type": "shopify",
      "options": [
        "update",
        [
          "order",
          {{ order.id | json }}
        ],
        {
          "tags": {{ order.tags | add_tag: email_sent_tag | json }}
        }
      ]
    }
  }
{% endif %}