{% if event.preview %}
  {% capture order_json %}
    {
      "customer": {
        "admin_graphql_api_id": "gid://shopify/Customer/1234567890"
      },
      "line_items": [
        {
          "product": {
            "tags":
              {% if options.only_copy_these_tags__array != blank %}
                {{ options.only_copy_these_tags__array | json }}
              {% else %}
                "club-limited, december-sale"
              {% endif  %}
          }
        }
      ]
    }
  {% endcapture %}

  {% assign order = order_json | parse_json %}
{% endif %}

{% assign product_tags_from_order = order.line_items | map: "product" | map: "tags" | join: ", " | split: ", " | sort | uniq %}
{% log product_tags_from_order: product_tags_from_order %}

{% if options.only_copy_these_tags__array == blank %}
  {% assign tags_to_copy = product_tags_from_order %}
{% else %}
  {% assign tags_to_copy = array %}

  {% assign whitelisted_tags = options.only_copy_these_tags__array %}
  {% log whitelisted_tags: whitelisted_tags %}

  {% for whitelisted_tag in whitelisted_tags %}
    {% if product_tags_from_order contains whitelisted_tag %}
      {% assign tags_to_copy[tags_to_copy.size] = whitelisted_tag %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if tags_to_copy != empty %}
  {% action "shopify" %}
    mutation {
      tagsAdd(
        id: {{ order.customer.admin_graphql_api_id | json }}
        tags: {{ tags_to_copy | json }}
      ) {
        userErrors {
          field
          message
        }
      }
    }
  {% endaction %}
{% endif %}