{% capture newline %}
{% endcapture %}

{% if event.topic == "locksmith/sessions/ping" %}
  {% if event.preview %}
    {% assign passcode_cache_key = "order_passcodes:000000" %}
    {% assign passcode_cache_val = "letmein, members17" %}
  {% else %}
    {% capture passcode_cache_key %}order_passcodes:{{ session.cart_token }}{% endcapture %}
    {% assign passcode_cache_val = cache[passcode_cache_key] %}
  {% endif %}

  {% for param_keyval in session.params %}
    {% assign param_key = param_keyval[0] %}
    {% assign param_val = param_keyval[1] %}

    {% if param_key contains "passcode" %}
      {% comment %}
        Using add_tag for easy, guaranteed-unique, comma-separated values
      {% endcomment %}
      {% assign passcode_cache_val = passcode_cache_val | add_tag: param_val %}
    {% endif %}
  {% endfor %}

  {% if event.preview or passcode_cache_val != blank %}
    {
      "action": {
        "type": "cache",
        "options": {
          "set": {
            "key": {{ passcode_cache_key | json }},
            "value": {{ passcode_cache_val | json }}
          }
        }
      }
    }
  {% endif %}
{% elsif event.topic == "shopify/orders/create" %}
  {% if event.preview %}
    {% assign passcode_cache_val = "letmein, members17" %}
  {% else %}
    {% capture passcode_cache_key %}order_passcodes:{{ order.cart_token }}{% endcapture %}
    {% assign passcode_cache_val = cache[passcode_cache_key] %}
  {% endif %}

  {% if event.preview or passcode_cache_val != blank %}
    {
      "action": {
        "type": "shopify",
        "options": [
          "update",
          ["order", {{ order.id | json }}],
          {
            "note": {{ order.note | append: newline | append: newline | append: options.note_prefix | append: " " | append: passcode_cache_val | strip | json }}
          }
        ]
      }
    }
  {% endif %}
{% endif %}