{% comment %}
  Express an opinion about option order:
  {{ options.order_count_minimums_and_tags__keyval_required }}
  {{ options.only_keep_the_tag_for_the_highest_minimum_count__boolean }}
  {{ options.only_tag_customers_with_an_active_account__boolean }}
{% endcomment %}

{% if event.preview or event.topic contains "shopify/customers/" %}
  {% assign customers = array %}
  {% assign customers[customers.size] = customer %}
{% elsif event.topic == "mechanic/user/trigger" %}
  {% assign customers = shop.customers %}
{% endif %}

{% for customer in customers %}
  {% if options.only_tag_customers_with_an_active_account__boolean and customer.state != "enabled" %}
    {% continue %}
  {% endif %}

  {% assign orders_count = customer.orders_count %}
  {% assign best_tag_minimum = 0 %}
  {% assign best_tag = nil %}
  {% assign all_fitting_tags = array %}
  {% assign all_possible_tags = array %}

  {% for pair in options.order_count_minimums_and_tags__keyval_required %}
    {% assign tag_minimum = pair[0] | times: 1 %}
    {% assign tag = pair[1] %}

    {% assign all_possible_tags[all_possible_tags.size] = tag %}

    {% if orders_count >= tag_minimum %}
      {% assign all_fitting_tags[all_fitting_tags.size] = tag %}

      {% if tag_minimum >= best_tag_minimum %}
        {% assign best_tag = tag %}
        {% assign best_tag_minimum = tag_minimum %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if options.only_keep_the_tag_for_the_highest_minimum_count__boolean %}
    {% assign customer_tags_to_save = customer.tags | remove_tags: all_possible_tags | add_tag: best_tag %}
  {% else %}
    {% assign customer_tags_to_save = customer.tags | remove_tags: all_possible_tags | add_tags: all_fitting_tags %}
  {% endif %}

  {% if event.preview or customer_tags_to_save != customer.tags %}
    {% action "shopify" %}
      [
        "update",
        ["customer", {{ customer.id | json }}],
        {
          "tags": {{ customer_tags_to_save | json }}
        }
      ]
    {% endaction %}
  {% endif %}
{% endfor %}